// A3S Agent Operating System - Architecture Model

model {

  // ═══════════════════════════════════════════
  //  External Actors
  // ═══════════════════════════════════════════

  actor developer 'Developer' {
    description 'Builds and deploys AI agents on A3S'
  }

  actor endUser 'End User' {
    description 'Interacts with AI agents via chat channels'
  }

  // ═══════════════════════════════════════════
  //  External Channels
  // ═══════════════════════════════════════════

  channel channels 'Chat Channels' {
    description '7-platform messaging integration'

    channel telegram 'Telegram'
    channel feishu 'Feishu / Lark'
    channel dingtalk 'DingTalk'
    channel wecom 'WeCom'
    channel slack 'Slack'
    channel discord 'Discord'
    channel webchat 'WebChat'
  }

  // ═══════════════════════════════════════════
  //  A3S Platform
  // ═══════════════════════════════════════════

  platform a3s 'A3S Agent OS' {
    description 'Agentic Adaptive Augmentation System'

    // ─── Gateway Layer ───

    gateway gw 'a3s-gateway' {
      description 'OS external gateway — single entry point for all traffic'
      technology 'Rust / Hyper / Tokio'

      service proxy 'Reverse Proxy' {
        description 'HTTP / HTTPS / WebSocket / gRPC / TCP / UDP / SSE'
      }
      service lb 'Load Balancer' {
        description 'Round-robin, weighted, least-connections'
      }
      service mw 'Middleware Chain' {
        description 'Auth, JWT, rate-limit, CORS, circuit-breaker, compress'
      }
      service webhookNorm 'Webhook Normalizer' {
        description 'Normalizes 7-platform webhook payloads'
      }
      service tls 'TLS / ACME' {
        description 'TLS termination with Let\'s Encrypt'
      }
      service meter 'Token Metering' {
        description 'Per-agent token usage tracking'
      }
    }

    // ─── Sandbox Layer ───

    sandbox box 'a3s-box' {
      description 'MicroVM sandbox runtime — hardware-isolated agent execution'
      technology 'Rust / libkrun'

      service vmRuntime 'MicroVM Runtime' {
        description 'libkrun ~200ms cold start, macOS HVF + Linux KVM'
      }
      service warmPool 'WarmPool' {
        description 'Pre-warmed VM pool for instant deployment'
      }
      service ociImages 'OCI Images' {
        description 'Docker-compatible image build, pull, push'
      }
      service networking 'Bridge Networking' {
        description 'passt-based networking'
      }
      service teeSupport 'TEE Support' {
        description 'AMD SEV-SNP Trusted Execution Environment'
      }
      service cri 'CRI Integration' {
        description 'Kubernetes Container Runtime Interface'
      }
    }

    // ─── Application Layer ───

    application safeclaw 'SafeClaw' {
      description 'OS main application — multi-agent coordinator'
      technology 'Rust / Tauri v2'

      engine agentEngine 'AgentEngine' {
        description 'Multi-agent coordination and lifecycle'
      }
      service channelRouter 'Channel Router' {
        description 'Routes messages from 7 platforms to agents'
      }
      service privacyEsc 'Privacy Escalation' {
        description 'Normal → Sensitive → Critical → TEE'
      }
      dsl a3sfile 'A3sfile DSL' {
        description 'Declarative agent topology and collaboration'
      }
    }

    // ─── Execution Layer ───

    agent code 'a3s-code' {
      description 'AI coding agent — core execution unit'
      technology 'Rust'

      tool-set builtinTools 'Built-in Tools' {
        description 'bash, read, write, edit, grep, glob, ls, web_fetch, web_search, cron, patch'
      }
      service sessions 'Multi-Session' {
        description 'Concurrent session management'
      }
      service permissions 'Permission System' {
        description 'Allow / Deny / Ask per-tool'
      }
      service reflection 'Reflection System' {
        description '10 error categories, 4 adaptive strategies'
      }
      service memory 'Memory System' {
        description 'Episodic / Semantic / Procedural'
      }
      service skills 'Skills & Subagents' {
        description 'Extensible skill system'
      }
      service lspInteg 'LSP Integration' {
        description 'Rust, Go, TypeScript, Python, C/C++'
      }
      service mcpSupport 'MCP Support' {
        description 'Model Context Protocol'
      }
    }

    scheduler lane 'a3s-lane' {
      description 'Per-session 6-priority queue: P0 system → P5 prompt'
      technology 'Rust'
    }

    // ─── Infrastructure Layer ───

    engine power 'a3s-power' {
      description 'Local LLM inference engine'
      technology 'Rust / llama.cpp'

      service ollamaApi 'Ollama API' {
        description '12+ endpoints, registry integration'
      }
      service openaiApi 'OpenAI API' {
        description '/v1/chat/completions, /v1/models, /v1/embeddings'
      }
      service inference 'GGUF Inference' {
        description 'llama.cpp, multi-GPU, LRU eviction'
      }
    }

    service search 'a3s-search' {
      description 'Meta search engine — 8 engines, consensus ranking'
      technology 'Rust'
    }

    service context 'a3s-context' {
      description 'Hierarchical context — Working / Short-term / Long-term'
      technology 'Rust'
    }

    service event 'a3s-event' {
      description 'Pluggable event system — pub/sub, AES-256-GCM'
      technology 'Rust / NATS JetStream'
    }

    service cron 'a3s-cron' {
      description 'Cron scheduling — standard + natural language'
      technology 'Rust'
    }

    // ─── Shared Libraries ───

    library privacy 'a3s-privacy' {
      description 'PII classification types'
    }
    library transport 'a3s-transport' {
      description 'vsock frame protocol'
    }
    library toolsCore 'a3s-tools-core' {
      description 'Core types for tool definitions'
    }
    library updater 'a3s-updater' {
      description 'Self-update via GitHub Releases'
    }

    // ─── SDKs ───

    sdk pythonSdk 'Python SDK' {
      description 'a3s-code Python SDK — 86 RPCs'
      technology 'Python / gRPC'
    }
    sdk tsSdk 'TypeScript SDK' {
      description '@a3s-lab/code TypeScript SDK — 86 RPCs'
      technology 'TypeScript / gRPC'
    }
    sdk deep 'a3s-deep' {
      description 'Agentic deep research — Plan → Search → Reflect'
      technology 'TypeScript'
    }
  }

  // ═══════════════════════════════════════════
  //  Relationships
  // ═══════════════════════════════════════════

  // --- Actor → Channels / Apps ---
  endUser -> channels 'sends messages'
  developer -> a3s.pythonSdk 'builds agents via'
  developer -> a3s.tsSdk 'builds agents via'

  // --- Channels → Gateway ---
  channels -> a3s.gw 'webhook payloads' {
    technology 'HTTPS'
  }

  // --- Gateway internals ---
  a3s.gw.webhookNorm -> a3s.gw.mw 'normalized payload'
  a3s.gw.mw -> a3s.gw.lb 'authenticated request'
  a3s.gw.lb -> a3s.gw.proxy 'balanced'

  // --- Gateway → Sandbox ---
  a3s.gw -> a3s.box 'routes traffic to MicroVM' {
    technology 'vsock / TCP'
  }

  // --- Sandbox → Application ---
  a3s.box -> a3s.safeclaw 'hosts' {
    technology 'vsock'
  }

  // --- Application → Execution ---
  a3s.safeclaw.agentEngine -> a3s.code 'orchestrates agents'
  a3s.safeclaw.a3sfile -> a3s.safeclaw.agentEngine 'declares topology for'
  a3s.safeclaw.channelRouter -> a3s.safeclaw.agentEngine 'dispatches messages to'

  // --- Execution internals ---
  a3s.code -> a3s.lane 'enqueues tasks'

  // --- Execution → Infrastructure ---
  a3s.code -> a3s.power 'LLM inference' {
    technology 'HTTP / OpenAI API'
  }
  a3s.code -> a3s.search 'web search'
  a3s.code -> a3s.context 'context retrieval'
  a3s.code -> a3s.cron 'schedules tasks'
  a3s.code -[async]-> a3s.event 'publishes events'
  a3s.event -[async]-> a3s.code 'delivers events'

  // --- Privacy flows ---
  a3s.safeclaw.privacyEsc -> a3s.box.teeSupport 'escalates to TEE'
  a3s.gw -> a3s.privacy 'classifies PII'

  // --- Shared library usage ---
  a3s.box -> a3s.transport 'uses vsock protocol'
  a3s.code -> a3s.toolsCore 'uses tool types'

  // --- SDK → Execution ---
  a3s.pythonSdk -> a3s.code 'gRPC calls' {
    technology 'gRPC / 86 RPCs'
  }
  a3s.tsSdk -> a3s.code 'gRPC calls' {
    technology 'gRPC / 86 RPCs'
  }
  a3s.deep -> a3s.tsSdk 'depends on'
  a3s.deep -> a3s.search 'research queries'
}
