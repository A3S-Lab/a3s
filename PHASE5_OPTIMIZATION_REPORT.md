# Phase 5 ä¼˜åŒ–å®æ–½æŠ¥å‘Š

## ä¼˜åŒ–ç›®æ ‡

æé«˜ CPU åˆ©ç”¨ç‡ï¼Œé€šè¿‡ `spawn_blocking` å°†é˜»å¡ I/O å’Œ CPU å¯†é›†å‹æ“ä½œç§»åˆ°ä¸“ç”¨çº¿ç¨‹æ± ã€‚

**ç›®æ ‡**: æé«˜ CPU åˆ©ç”¨ç‡åˆ° 40-60%ï¼Œæ€§èƒ½æå‡ +20-40%

## é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€ï¼ˆPhase 4 åï¼‰

**CPU åˆ©ç”¨ç‡**: 20-30%ï¼ˆI/O å¯†é›†å‹ä»»åŠ¡ä¸ºä¸»ï¼‰

**é—®é¢˜**:
1. **grep å·¥å…·**: ä½¿ç”¨åŒæ­¥é˜»å¡çš„ `std::fs::read_to_string` + CPU å¯†é›†å‹æ­£åˆ™åŒ¹é…
2. **glob å·¥å…·**: ä½¿ç”¨åŒæ­¥é˜»å¡çš„æ–‡ä»¶ç³»ç»Ÿéå† `glob::glob()`
3. **é˜»å¡å¼‚æ­¥è¿è¡Œæ—¶**: è¿™äº›åŒæ­¥æ“ä½œåœ¨ Tokio å¼‚æ­¥è¿è¡Œæ—¶ä¸­æ‰§è¡Œï¼Œé˜»å¡äº† worker çº¿ç¨‹

**å½±å“**:
- Worker çº¿ç¨‹è¢«é˜»å¡ï¼Œæ— æ³•å¤„ç†å…¶ä»–å¼‚æ­¥ä»»åŠ¡
- CPU åˆ©ç”¨ç‡ä½
- å¹¶è¡Œæ•ˆç‡å·®

## è§£å†³æ–¹æ¡ˆ

### ä½¿ç”¨ `tokio::task::spawn_blocking`

**åŸç†**:
- `spawn_blocking` å°†ä»»åŠ¡ç§»åˆ°ä¸“ç”¨çš„ blocking çº¿ç¨‹æ± 
- ä¸ä¼šé˜»å¡å¼‚æ­¥è¿è¡Œæ—¶çš„ worker çº¿ç¨‹
- é€‚åˆ CPU å¯†é›†å‹å’ŒåŒæ­¥ I/O æ“ä½œ

**Phase 2 å·²ä¼˜åŒ–**: Tokio è¿è¡Œæ—¶é…ç½®
```rust
tokio::runtime::Builder::new_multi_thread()
    .worker_threads(num_cpus::get() * 2)  // 2x CPU cores
    .max_blocking_threads(512)             // 512 blocking threads
    .build()
```

### ä¼˜åŒ–çš„å·¥å…·

#### 1. grep å·¥å…·ï¼ˆCPU å¯†é›†å‹ï¼‰

**ä¼˜åŒ–å‰**:
```rust
async fn execute(&self, args: &Value, ctx: &ToolContext) -> Result<ToolOutput> {
    // åœ¨å¼‚æ­¥è¿è¡Œæ—¶ä¸­æ‰§è¡ŒåŒæ­¥æ“ä½œ
    let content = std::fs::read_to_string(file_path)?;  // é˜»å¡ï¼
    if regex.is_match(line) {  // CPU å¯†é›†å‹
        // ...
    }
}
```

**ä¼˜åŒ–å**:
```rust
async fn execute(&self, args: &Value, ctx: &ToolContext) -> Result<ToolOutput> {
    // ç§»åˆ° blocking çº¿ç¨‹æ± 
    let result = tokio::task::spawn_blocking(move || {
        // åŒæ­¥æ“ä½œåœ¨ä¸“ç”¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
        let content = std::fs::read_to_string(file_path)?;
        if regex.is_match(line) {
            // CPU å¯†é›†å‹æ­£åˆ™åŒ¹é…
        }
        ToolOutput::success(output)
    })
    .await
    .map_err(|e| anyhow::anyhow!("Grep task panicked: {}", e))?;

    Ok(result)
}
```

**ä¼˜åŠ¿**:
- æ–‡ä»¶è¯»å–å’Œæ­£åˆ™åŒ¹é…åœ¨ blocking çº¿ç¨‹æ± æ‰§è¡Œ
- ä¸é˜»å¡å¼‚æ­¥ worker çº¿ç¨‹
- æ›´å¥½çš„ CPU åˆ©ç”¨ç‡

#### 2. glob å·¥å…·ï¼ˆI/O å¯†é›†å‹ï¼‰

**ä¼˜åŒ–å‰**:
```rust
async fn execute(&self, args: &Value, ctx: &ToolContext) -> Result<ToolOutput> {
    // åœ¨å¼‚æ­¥è¿è¡Œæ—¶ä¸­æ‰§è¡ŒåŒæ­¥æ–‡ä»¶ç³»ç»Ÿéå†
    let entries = glob::glob(&pattern)?;  // é˜»å¡ï¼
    for entry in entries {
        // ...
    }
}
```

**ä¼˜åŒ–å**:
```rust
async fn execute(&self, args: &Value, ctx: &ToolContext) -> Result<ToolOutput> {
    // ç§»åˆ° blocking çº¿ç¨‹æ± 
    let result = tokio::task::spawn_blocking(move || {
        // æ–‡ä»¶ç³»ç»Ÿéå†åœ¨ä¸“ç”¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
        let entries = glob::glob(&pattern)?;
        for entry in entries {
            // ...
        }
        ToolOutput::success(output)
    })
    .await
    .map_err(|e| anyhow::anyhow!("Glob task panicked: {}", e))?;

    Ok(result)
}
```

**ä¼˜åŠ¿**:
- æ–‡ä»¶ç³»ç»Ÿéå†åœ¨ blocking çº¿ç¨‹æ± æ‰§è¡Œ
- ä¸é˜»å¡å¼‚æ­¥ worker çº¿ç¨‹
- æ›´å¥½çš„å¹¶å‘æ€§

### å…¶ä»–å·¥å…·çŠ¶æ€

| å·¥å…· | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| read | âœ… å·²ä¼˜åŒ– | ä½¿ç”¨ `tokio::fs::read_to_string`ï¼ˆå¼‚æ­¥ï¼‰ |
| ls | âœ… å·²ä¼˜åŒ– | ä½¿ç”¨ `tokio::fs::read_dir`ï¼ˆå¼‚æ­¥ï¼‰ |
| write | âœ… å·²ä¼˜åŒ– | ä½¿ç”¨ `tokio::fs::write`ï¼ˆå¼‚æ­¥ï¼‰ |
| edit | âœ… å·²ä¼˜åŒ– | ä½¿ç”¨ `tokio::fs`ï¼ˆå¼‚æ­¥ï¼‰ |
| bash | âœ… å·²ä¼˜åŒ– | ä½¿ç”¨ `tokio::process::Command`ï¼ˆå¼‚æ­¥ï¼‰ |
| grep | âœ… Phase 5 | ä½¿ç”¨ `spawn_blocking` |
| glob | âœ… Phase 5 | ä½¿ç”¨ `spawn_blocking` |

## å®æ–½ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

**core/src/tools/builtin/grep.rs**:
- å°†æ•´ä¸ª grep é€»è¾‘åŒ…è£…åœ¨ `spawn_blocking` ä¸­
- ç§»åŠ¨æ‰€æœ‰éœ€è¦çš„å˜é‡ï¼ˆpattern, workspace, etc.ï¼‰
- å¤„ç† panic é”™è¯¯

**core/src/tools/builtin/glob_tool.rs**:
- å°†æ•´ä¸ª glob é€»è¾‘åŒ…è£…åœ¨ `spawn_blocking` ä¸­
- ç§»åŠ¨æ‰€æœ‰éœ€è¦çš„å˜é‡
- å¤„ç† panic é”™è¯¯

### ä»£ç ä¿®æ”¹ç»Ÿè®¡

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| grep.rs | æ·»åŠ  spawn_blocking åŒ…è£… | +15, -10 |
| glob_tool.rs | æ·»åŠ  spawn_blocking åŒ…è£… | +12, -8 |
| **æ€»è®¡** | | **+27, -18** |

## é¢„æœŸæ•ˆæœ

### CPU åˆ©ç”¨ç‡æå‡

**ä¼˜åŒ–å‰**:
- Worker çº¿ç¨‹: 20-30% åˆ©ç”¨ç‡ï¼ˆè¢«é˜»å¡ï¼‰
- Blocking çº¿ç¨‹: 0% åˆ©ç”¨ç‡ï¼ˆæœªä½¿ç”¨ï¼‰

**ä¼˜åŒ–å**:
- Worker çº¿ç¨‹: 30-40% åˆ©ç”¨ç‡ï¼ˆä¸è¢«é˜»å¡ï¼‰
- Blocking çº¿ç¨‹: 20-30% åˆ©ç”¨ç‡ï¼ˆå¤„ç† grep/globï¼‰
- **æ€»ä½“**: 40-60% CPU åˆ©ç”¨ç‡

### æ€§èƒ½æå‡é¢„æœŸ

| åœºæ™¯ | Phase 4 | Phase 5 (é¢„æœŸ) | æ”¹å–„ |
|------|---------|---------------|------|
| 8 æ–‡ä»¶è¯»å– | 1.63x | 1.8-2.0x | +10-23% |
| 12 æ–‡ä»¶è¯»å– | 1.15x | 1.3-1.5x | +13-30% |
| grep å¯†é›† | 1.0x | 1.5-2.0x | +50-100% |

### ç†è®ºåˆ†æ

**é˜»å¡æ—¶é—´å‡å°‘**:
- ä¼˜åŒ–å‰: grep é˜»å¡ worker çº¿ç¨‹ ~100ms
- ä¼˜åŒ–å: grep åœ¨ blocking çº¿ç¨‹æ± ï¼Œworker çº¿ç¨‹å¯å¤„ç†å…¶ä»–ä»»åŠ¡
- **æ”¶ç›Š**: æ›´å¥½çš„å¹¶å‘æ€§

**CPU åˆ©ç”¨ç‡æå‡**:
- ä¼˜åŒ–å‰: 8 ä¸ªä»»åŠ¡ï¼Œ4 ä¸ª worker çº¿ç¨‹ï¼Œåˆ©ç”¨ç‡ 20-30%
- ä¼˜åŒ–å: 8 ä¸ªä»»åŠ¡ï¼Œ4 worker + 512 blocking çº¿ç¨‹ï¼Œåˆ©ç”¨ç‡ 40-60%
- **æ”¶ç›Š**: +33-100% CPU åˆ©ç”¨ç‡

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ä¸é˜»å¡å¼‚æ­¥è¿è¡Œæ—¶

**ä¼˜åŒ–å‰**:
```
Worker Thread 1: [grep é˜»å¡ 100ms] â†’ æ— æ³•å¤„ç†å…¶ä»–ä»»åŠ¡
Worker Thread 2: [grep é˜»å¡ 100ms] â†’ æ— æ³•å¤„ç†å…¶ä»–ä»»åŠ¡
```

**ä¼˜åŒ–å**:
```
Worker Thread 1: [æäº¤ grep] â†’ [å¤„ç†å…¶ä»–ä»»åŠ¡] â†’ [æ¥æ”¶ç»“æœ]
Worker Thread 2: [æäº¤ grep] â†’ [å¤„ç†å…¶ä»–ä»»åŠ¡] â†’ [æ¥æ”¶ç»“æœ]
Blocking Thread 1: [æ‰§è¡Œ grep 100ms]
Blocking Thread 2: [æ‰§è¡Œ grep 100ms]
```

### 2. æ›´å¥½çš„èµ„æºåˆ©ç”¨

**Tokio è¿è¡Œæ—¶æ¶æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Tokio Runtime                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Worker 1 â”‚  â”‚ Worker 2 â”‚  â”‚ Worker 3 â”‚  â”‚ Worker 4 â”‚â”‚
â”‚  â”‚ (å¼‚æ­¥)   â”‚  â”‚ (å¼‚æ­¥)   â”‚  â”‚ (å¼‚æ­¥)   â”‚  â”‚ (å¼‚æ­¥)   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â†“             â†“             â†“             â†“        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Blocking Thread Pool (512)             â”‚ â”‚
â”‚  â”‚  [grep] [grep] [glob] [grep] [glob] ...          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å‘åå…¼å®¹

âœ… **API ä¸å˜**: å·¥å…·æ¥å£ä¿æŒä¸å˜
âœ… **è¡Œä¸ºä¸€è‡´**: åŠŸèƒ½å®Œå…¨ç›¸åŒ
âœ… **æ€§èƒ½æå‡**: åªæ˜¯æ›´é«˜æ•ˆ

## ä¸å…¶ä»–ä¼˜åŒ–çš„ååŒ

### Phase 1-5 ååŒæ•ˆæœ

```
Phase 1: æä¾›èƒ½åŠ›ï¼ˆå¹¶å‘åº¦ 4â†’12ï¼‰
    â†“
Phase 2: ä¼˜åŒ–æ€§èƒ½ï¼ˆçº¿ç¨‹æ•° 2xï¼ŒTask ID 10xï¼Œblocking 512ï¼‰
    â†“
Phase 3: æ™ºèƒ½å†³ç­–ï¼ˆä½•æ—¶ä½¿ç”¨å¹¶è¡Œï¼‰
    â†“
Phase 4: æ‰¹é‡ä¼˜åŒ–ï¼ˆå‡å°‘é”ç«äº‰ï¼‰
    â†“
Phase 5: å¤šæ ¸åˆ©ç”¨ï¼ˆspawn_blockingï¼Œä¸é˜»å¡ workerï¼‰
    â†“
æœ€ä¼˜æ€§èƒ½ï¼ˆ1.8-2.0xï¼ŒCPU åˆ©ç”¨ç‡ 40-60%ï¼‰
```

### Phase 2 + Phase 5 ååŒ

**Phase 2**: å¢åŠ  blocking çº¿ç¨‹æ± åˆ° 512
**Phase 5**: ä½¿ç”¨ blocking çº¿ç¨‹æ± æ‰§è¡Œ grep/glob

**ååŒæ•ˆæœ**:
- Phase 2 æä¾›äº†è¶³å¤Ÿçš„ blocking çº¿ç¨‹
- Phase 5 å……åˆ†åˆ©ç”¨äº†è¿™äº›çº¿ç¨‹
- ä¸¤è€…ç»“åˆï¼Œæœ€å¤§åŒ– CPU åˆ©ç”¨ç‡

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•åœºæ™¯

1. **Benchmark æµ‹è¯•** (test_session_parallel_benchmark.py)
   - 8 ä¸ªæ–‡ä»¶è¯»å–
   - éªŒè¯ spawn_blocking æ•ˆæœ

2. **Grep å¯†é›†æµ‹è¯•**
   - å¤§é‡ grep æ“ä½œ
   - éªŒè¯ CPU åˆ©ç”¨ç‡æå‡

3. **æ··åˆå·¥ä½œè´Ÿè½½**
   - grep + read + glob
   - éªŒè¯ä¸åŒå·¥å…·çš„ååŒ

### éªŒè¯æŒ‡æ ‡

| æŒ‡æ ‡ | Phase 4 | Phase 5 ç›®æ ‡ |
|------|---------|-------------|
| 8 æ–‡ä»¶ (conc=16) | 1.63x | â‰¥ 1.8x |
| CPU åˆ©ç”¨ç‡ | 20-30% | â‰¥ 40% |
| Worker é˜»å¡æ—¶é—´ | é«˜ | ä½ |

## å®ç°è´¨é‡

### ä»£ç è´¨é‡

âœ… **ç®€æ´**: 27 è¡Œæ–°å¢ä»£ç 
âœ… **æ¸…æ™°**: spawn_blocking åŒ…è£…æ˜ç¡®
âœ… **å®‰å…¨**: å¤„ç† panic é”™è¯¯
âœ… **å¯ç»´æŠ¤**: æ˜“äºç†è§£å’Œä¿®æ”¹

### å‘åå…¼å®¹

âœ… **API ä¸å˜**: å·¥å…·æ¥å£ä¿æŒä¸å˜
âœ… **åŠŸèƒ½ä¸€è‡´**: è¡Œä¸ºå®Œå…¨ç›¸åŒ
âœ… **æ€§èƒ½æå‡**: åªæ˜¯æ›´é«˜æ•ˆ

## æ€»ç»“

### Phase 5 ä¼˜åŒ–å®Œæˆ

âœ… **å®æ–½çš„ä¼˜åŒ–**:
- grep å·¥å…·ä½¿ç”¨ spawn_blocking
- glob å·¥å…·ä½¿ç”¨ spawn_blocking
- ä¸é˜»å¡å¼‚æ­¥è¿è¡Œæ—¶

âœ… **é¢„æœŸæ€§èƒ½æå‡**: +10-30%

âœ… **å…³é”®æ”¹è¿›**:
- CPU åˆ©ç”¨ç‡: 20-30% â†’ 40-60%
- Worker çº¿ç¨‹ä¸è¢«é˜»å¡
- æ›´å¥½çš„å¹¶å‘æ€§

### ç´¯è®¡æ€§èƒ½æå‡

| é˜¶æ®µ | ä¼˜åŒ–å†…å®¹ | æ€§èƒ½ | ç´¯è®¡ |
|------|---------|------|------|
| Baseline | - | 1.0x | 1.0x |
| Phase 1 | æé«˜å¹¶å‘åº¦ | 1.48x | 1.48x |
| Phase 2 | å‡å°‘å¼€é”€ | 1.52x | 1.52x |
| Phase 3 | æ™ºèƒ½å¯ç”¨ | 1.04x | 1.04x |
| Phase 4 | æ‰¹é‡æäº¤ | 1.63x | 1.63x |
| Phase 5 | å¤šæ ¸åˆ©ç”¨ | 1.8-2.0x (é¢„æœŸ) | **1.8-2.0x** |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… Phase 5 ä»£ç å·²æäº¤
2. ğŸ”„ ç­‰å¾…æµ‹è¯•ç»“æœéªŒè¯
3. ğŸ“‹ å‡†å¤‡æœ€ç»ˆæ€»ç»“

---

**å®Œæˆæ—¶é—´**: 2026-02-19
**ä¼˜åŒ–ç‰ˆæœ¬**: A3S Code v0.7.2+ (Phase 5)
**é¢„æœŸæå‡**: +10-30% (1.63x â†’ 1.8-2.0x)
**å…³é”®ç‰¹æ€§**: spawn_blockingï¼Œä¸é˜»å¡å¼‚æ­¥è¿è¡Œæ—¶
