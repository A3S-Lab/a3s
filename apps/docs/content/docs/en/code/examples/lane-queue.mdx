---
title: Lane Queue
description: Priority-based task queue with preemption
---

import { Tab, Tabs } from 'fumadocs-ui/components/tabs';
import { Callout } from 'fumadocs-ui/components/callout';

# Lane Queue

The lane queue provides priority-based task scheduling with four lanes. High-priority tasks preempt lower-priority ones already in the queue.

## Lanes (highest â†’ lowest priority)

| Lane | Priority | Use case |
|------|----------|---------|
| `Control` | 1 (highest) | Stop/cancel commands |
| `Query` | 2 | Read-only lookups |
| `Execute` | 3 | File writes, tool calls |
| `Generate` | 4 (lowest) | Long LLM generation |

## Basic Queue Setup

<Tabs groupId="lang" items={['Rust', 'Python', 'Node.js']}>
<Tab value="Rust">
```rust
use a3s_code_core::{Agent, SessionOptions, SessionQueueConfig};

let queue_config = SessionQueueConfig::default()
    .with_lane_features()
    .with_metrics();

let opts = SessionOptions::new()
    .with_permissive_policy()
    .with_queue_config(queue_config);

let session = agent.session("/my-project", Some(opts))?;

// Tasks are automatically routed to the appropriate lane
let result = session.send("List all Rust files", None).await?;
println!("{}", result.text);
```

**Run:** `cargo run --example test_task_priority`
**Source:** [`core/examples/test_task_priority.rs`](https://github.com/A3S-Lab/Code/blob/main/core/examples/test_task_priority.rs)
</Tab>
<Tab value="Python">
```python
from a3s_code import SessionQueueConfig

queue_config = SessionQueueConfig()
queue_config.enable_all_features = True

session = agent.session("/my-project",
    permissive=True,
    queue_config=queue_config,
)
result = await session.send("List all Rust files")
print(result.text)
```

**Run:** `python examples/test_task_priority.py`
**Source:** [`sdk/python/examples/test_task_priority.py`](https://github.com/A3S-Lab/Code/blob/main/sdk/python/examples/test_task_priority.py)
</Tab>
<Tab value="Node.js">
```javascript
const session = agent.session('/my-project', {
  permissive: true,
  queueConfig: { enableAllFeatures: true },
});
const result = await session.send('List all Rust files');
console.log(result.text);
```

**Run:** `node examples/test_task_priority.js`
**Source:** [`sdk/node/examples/test_task_priority.js`](https://github.com/A3S-Lab/Code/blob/main/sdk/node/examples/test_task_priority.js)
</Tab>
</Tabs>

## Priority Preemption

<Tabs groupId="lang" items={['Rust', 'Python', 'Node.js']}>
<Tab value="Rust">
```rust
use a3s_code_core::queue::{ExternalTask, SessionLane};

// Submit a low-priority background task
session.submit_task(ExternalTask::new(
    "background-analysis",
    SessionLane::Generate,
    serde_json::json!({ "prompt": "Analyze the entire codebase" }),
)).await?;

// Submit a high-priority query that preempts the background task
session.submit_task(ExternalTask::new(
    "urgent-query",
    SessionLane::Query,
    serde_json::json!({ "prompt": "What is the current git branch?" }),
)).await?;

// urgent-query runs first, background-analysis resumes after
```
</Tab>
<Tab value="Python">
```python
# Submit a low-priority background task
await session.submit_task({
    "id": "background-analysis",
    "lane": "generate",
    "payload": {"prompt": "Analyze the entire codebase"},
})

# Submit a high-priority query that preempts it
await session.submit_task({
    "id": "urgent-query",
    "lane": "query",
    "payload": {"prompt": "What is the current git branch?"},
})
```
</Tab>
<Tab value="Node.js">
```javascript
// Submit a low-priority background task
await session.submitTask({
  id: 'background-analysis',
  lane: 'generate',
  payload: { prompt: 'Analyze the entire codebase' },
});

// Submit a high-priority query that preempts it
await session.submitTask({
  id: 'urgent-query',
  lane: 'query',
  payload: { prompt: 'What is the current git branch?' },
});
```
</Tab>
</Tabs>

<Callout type="info">
For full lane queue documentation, see [Lane Queue](/docs/code/lane-queue).
</Callout>

## API Reference

### SessionQueueConfig

| Option | Rust | Python | Node.js | Default |
|--------|------|--------|---------|---------|
| Enable lane features | `.with_lane_features()` | `enable_all_features=True` | `enableAllFeatures: true` | `false` |
| Enable metrics | `.with_metrics()` | `enable_metrics=True` | `enableMetrics: true` | `false` |
| Query concurrency | `.query_max_concurrency(n)` | `query_max_concurrency=n` | `queryMaxConcurrency: n` | `10` |
| Execute concurrency | `.execute_max_concurrency(n)` | `execute_max_concurrency=n` | `executeMaxConcurrency: n` | `5` |

### ExternalTask fields (Rust)

| Field | Type | Description |
|-------|------|-------------|
| `id` | `String` | Unique task identifier |
| `lane` | `SessionLane` | `Control`, `Query`, `Execute`, or `Generate` |
| `payload` | `serde_json::Value` | Task data (prompt, args, etc.) |

### Queue management methods

| Method | Rust | Python | Node.js |
|--------|------|--------|---------|
| Submit task | `session.submit_task(task).await?` | `await session.submit_task({...})` | `await session.submitTask({...})` |
| Queue stats | `session.queue_stats().await` | `await session.queue_stats()` | `await session.queueStats()` |
| Queue metrics | `session.queue_metrics().await` | `await session.queue_metrics()` | `await session.queueMetrics()` |
| Dead letters | `session.dead_letters().await` | `await session.dead_letters()` | `await session.deadLetters()` |
