---
title: Commands
description: Define, submit, and track command execution through the queue
---

# Commands

Commands are the unit of work in A3S Lane. Any struct that implements the `Command` trait can be submitted to a lane for async execution.

## Command Trait

```rust
use a3s_lane::Result;
use async_trait::async_trait;
use serde_json::Value;

#[async_trait]
pub trait Command: Send + Sync {
    /// Execute the command and return a JSON result
    async fn execute(&self) -> Result<Value>;

    /// Return a string identifier for this command type
    fn command_type(&self) -> &str;
}
```

Commands must be `Send + Sync` since they are executed on Tokio tasks. The return type is always `serde_json::Value`, providing a uniform interface regardless of the underlying work.

## Defining Commands

```rust
struct AnalyzeText {
    text: String,
    model: String,
}

#[async_trait]
impl Command for AnalyzeText {
    async fn execute(&self) -> Result<Value> {
        let analysis = run_analysis(&self.text, &self.model).await?;
        Ok(serde_json::json!({
            "sentiment": analysis.sentiment,
            "topics": analysis.topics,
            "confidence": analysis.confidence,
        }))
    }

    fn command_type(&self) -> &str {
        "analyze_text"
    }
}
```

The `command_type()` return value is used in event payloads, dead letter queue entries, storage records, and metrics labels.

## Submitting Commands

Submit a boxed command to a specific lane. Returns a oneshot receiver for the result:

```rust
let cmd = Box::new(AnalyzeText {
    text: "A3S Lane is fast".into(),
    model: "sentiment-v2".into(),
});

let rx = manager.submit("query", cmd).await?;
```

### Awaiting Results

```rust
// Block until the command completes
let result = rx.await??;
println!("Analysis: {}", result);
```

The double `?` unwraps both the oneshot channel (`RecvError`) and the command result (`LaneError`).

### Fire and Forget

Drop the receiver if you don't need the result:

```rust
let _ = manager.submit("background", cmd).await?;
```

### Error Handling

```rust
match rx.await {
    Ok(Ok(value)) => println!("Success: {}", value),
    Ok(Err(e)) => match e {
        LaneError::Timeout(d) => println!("Timed out after {:?}", d),
        LaneError::CommandError(msg) => println!("Command failed: {}", msg),
        LaneError::LaneNotFound(id) => println!("No such lane: {}", id),
        LaneError::ShutdownInProgress => println!("Queue is shutting down"),
        _ => println!("Error: {}", e),
    },
    Err(_) => println!("Channel dropped"),
}
```

## Execution Lifecycle

```
submit() --> Pending Queue --> Scheduler --> Execute --> Result
                                  |              |
                                  |         (on failure)
                                  |              |
                                  |    Retry? --yes--> Re-enqueue with delay
                                  |       |
                                  |      no
                                  |       |
                                  |       v
                                  |   Dead Letter Queue
                                  |
                             (on timeout)
                                  |
                                  v
                          LaneError::Timeout
```

1. **Submission** - Command is boxed and enqueued. Persisted to storage if configured.
2. **Scheduling** - Background loop (10ms) picks the highest-priority lane with available capacity.
3. **Execution** - `execute()` is called inside a Tokio task, wrapped with timeout if configured.
4. **Completion** - Result sent to the oneshot receiver. Command removed from storage.
5. **Retry** - On failure with retries remaining, re-enqueued after a delay.
6. **Dead Letter** - If all retries exhausted, moved to the DLQ.

## Queue Stats

```rust
let stats = manager.stats().await?;
println!("Total pending: {}", stats.total_pending);
println!("Total active: {}", stats.total_active);
println!("Dead letters: {}", stats.dead_letter_count);
```

| Field | Type | Description |
|-------|------|-------------|
| `total_pending` | `usize` | Commands waiting across all lanes |
| `total_active` | `usize` | Commands executing across all lanes |
| `dead_letter_count` | `usize` | Failed commands in the DLQ |
| `lanes` | `HashMap<String, LaneStatus>` | Per-lane breakdown |
