---
title: A3S Box
description: 轻量级 MicroVM 运行时，提供类 Docker CLI、Kubernetes CRI 和硬件级 TEE 安全
---

# A3S Box

A3S Box 是一个轻量级 MicroVM 运行时，提供类容器的使用体验和 VM 级别的隔离。基于 [libkrun](https://github.com/containers/libkrun) 构建，冷启动时间不到 200ms，兼容 Docker CLI，支持 Kubernetes CRI 集成和 AMD SEV-SNP 机密计算。

## 架构

```
┌──────────────────────────────────────────────────────┐
│                宿主机 (a3s-box CLI)                   │
│  ┌────────────────────────────────────────────────┐  │
│  │              CLI（52 个命令）                   │  │
│  │  run, create, exec, logs, ps, network...       │  │
│  └───────────────────┬────────────────────────────┘  │
│                      │                                │
│  ┌───────────────────▼────────────────────────────┐  │
│  │         状态 (~/.a3s/)                          │  │
│  │  boxes.json · images/ · volumes/               │  │
│  └───────────────────┬────────────────────────────┘  │
│                      │                                │
│  ┌───────────────────▼────────────────────────────┐  │
│  │         运行时引擎                               │  │
│  │  VmManager · OCI · WarmPool · TEE · Network    │  │
│  │  gRPC 客户端（Exec、PTY、Attestation）          │  │
│  └───────────────────┬────────────────────────────┘  │
│                      │ vsock                          │
└──────────────────────┼───────────────────────────────┘
                       │
┌──────────────────────▼───────────────────────────────┐
│              Guest VM (aarch64-linux)                  │
│  ┌────────────────────────────────────────────────┐  │
│  │         guest-init (PID 1)                      │  │
│  │  Exec 服务 (:4089) · PTY 服务 (:4090)          │  │
│  │  Attestation 服务 (:4091)                       │  │
│  └───────────────────┬────────────────────────────┘  │
│                      │                                │
│  ┌───────────────────▼────────────────────────────┐  │
│  │         用户容器（命名空间隔离）                 │  │
│  │  /a3s/workspace/ · /a3s/skills/ · /run/secrets │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

## Crate 结构

A3S Box 由 7 个 crate 组成，各司其职：

| Crate | 职责 |
|-------|------|
| `a3s-box-core` | 共享类型：配置、错误、事件、网络模式、卷/PTY/DNS 类型 |
| `a3s-box-runtime` | VM 生命周期、OCI 镜像、热池、TEE、网络、gRPC 客户端 |
| `a3s-box-cli` | 类 Docker CLI，52 个命令，状态持久化，输出格式化 |
| `a3s-box-cri` | Kubernetes 容器运行时接口（CRI）gRPC 实现 |
| `a3s-box-shim` | VM 子进程，通过 libkrun（HVF/KVM）桥接宿主机和 VM |
| `a3s-box-guest-init` | Guest PID 1：挂载文件系统、启动服务、运行用户入口 |
| `a3s-box-sdk` | 嵌入式沙箱 SDK：从 Rust 代码创建、执行、停止 MicroVM |

## VM 生命周期

```
Created ──→ Ready ──→ Busy ──→ Compacting ──→ Ready ──→ Stopped
 (创建)     (启动)   (执行)    (上下文回收)    (完成)    (终止)
```

| 状态 | 说明 |
|------|------|
| `Created` | 配置已捕获，VM 尚未启动 |
| `Ready` | VM 已启动，Agent 已初始化，gRPC 健康 |
| `Busy` | 会话正在活跃处理中 |
| `Compacting` | 上下文压缩进行中 |
| `Stopped` | VM 已终止，资源已释放 |

## Vsock 通信

宿主机与 Guest 通过 vsock（virtio socket）通信，各服务使用独立端口：

| 端口 | 服务 | 协议 |
|------|------|------|
| 4088 | Agent 控制 | gRPC（健康检查、指标） |
| 4089 | Exec 服务 | gRPC（命令执行） |
| 4090 | PTY 服务 | gRPC（终端 I/O） |
| 4091 | Attestation 服务 | gRPC + RA-TLS（TEE 操作） |

## 主要特性

- **冷启动 < 200ms**（Apple HVF / Linux KVM）
- **兼容 Docker CLI**，52 个命令（`run`、`exec`、`logs`、`ps`、`build`、`snapshot`、`compose` 等）
- **OCI 镜像支持** — 拉取、推送、构建、缓存、标签、检查；每个拉取的镜像都暴露 manifest digest
- **Dockerfile 构建** — 支持全部 17 条指令，`ADD <url>` HTTP 下载，`ONBUILD` 触发器继承，多阶段、多平台
- **镜像签名** — cosign 密钥签名和无密钥（OIDC + Rekor）拉取时验证
- **热池（Warm Pool）** — 预启动 VM 池，可配置空闲 TTL，实现即时分配
- **三种网络模式** — TSI（默认，零配置）、Bridge（passt，容器间 DNS）、None（气隙隔离）
- **AMD SEV-SNP** — 硬件内存加密、远程证明、RA-TLS、重新证明、回滚保护
- **密封存储** — AES-256-GCM 数据绑定到 TEE 度量值和/或芯片身份
- **密钥注入** — 通过 RA-TLS 传递密钥，写入 `/run/secrets/`（权限 0400）
- **Kubernetes CRI** — 完整 CRI v1 实现，RuntimeClass，Helm Chart，流式 exec/attach/port-forward
- **Compose 编排** — 多服务 `compose.yaml`，支持健康感知的启动顺序
- **快照** — 创建、恢复、列出、删除 VM 状态的时间点快照
- **资源控制** — CPU 绑定、cgroup v2 CPU/内存配额、PID 限制、ulimits
- **命名空间隔离** — 每个 VM 内的 mount、PID、IPC、UTS、user、cgroup 命名空间
- **安全** — seccomp BPF 架构验证、能力丢弃（bounding + ambient）、AppArmor/SELinux 标签
- **卷管理** — 命名卷、绑定挂载、tmpfs、只读挂载
- **日志** — JSON 文件驱动（gzip 压缩轮转）、syslog 驱动（UDP/TCP）
- **嵌入式 SDK** — Rust、Python、TypeScript SDK；`exec`、`exec_stream`、上传/下载、端口转发、工作区
- **可观测性** — 19 个 Prometheus 指标、OpenTelemetry 追踪 span、持久化审计日志
