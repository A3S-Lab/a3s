---
title: 可观测性
description: 指标收集、延迟直方图和可配置告警
---

import { TypeTable } from 'fumadocs-ui/components/type-table';

# 可观测性

A3S Lane 提供内置的指标收集和告警功能，用于生产环境监控。追踪命令吞吐量、延迟百分位数、队列深度，并设置基于阈值的告警。

## 指标

### 启用指标

```rust
use a3s_lane::QueueMetrics;

let manager = QueueManagerBuilder::new(emitter)
    .with_default_lanes()
    .with_metrics(QueueMetrics::local())
    .build()
    .await?;
```

`QueueMetrics::local()` 使用内存后端。生产环境中，可实现自定义 `MetricsBackend`（如 Prometheus、Datadog）。

### 读取指标

```rust
let metrics = manager.metrics().unwrap();
let snapshot = metrics.snapshot().await;

// 计数器
println!("Submitted: {:?}", snapshot.counters.get("lane.commands.submitted"));
println!("Completed: {:?}", snapshot.counters.get("lane.commands.completed"));
println!("Failed: {:?}", snapshot.counters.get("lane.commands.failed"));

// 仪表
println!("Queue depth: {:?}", snapshot.gauges.get("lane.queue.depth.query"));
println!("Active: {:?}", snapshot.gauges.get("lane.queue.active.query"));

// 直方图
if let Some(latency) = snapshot.histograms.get("lane.command.latency_ms.query") {
    println!("Latency p50: {}ms", latency.percentiles.p50);
    println!("Latency p95: {}ms", latency.percentiles.p95);
    println!("Latency p99: {}ms", latency.percentiles.p99);
}
```

### 可用指标

**计数器**（单调递增）：

<TypeTable
  type={{
    "lane.commands.submitted": {
      description: "提交的命令总数",
    },
    "lane.commands.completed": {
      description: "成功完成的命令数",
    },
    "lane.commands.failed": {
      description: "执行失败的命令数",
    },
    "lane.commands.timeout": {
      description: "超时的命令数",
    },
    "lane.commands.retried": {
      description: "重试次数",
    },
    "lane.commands.dead_lettered": {
      description: "移入 DLQ 的命令数",
    },
  }}
/>

**仪表**（时间点值）：

<TypeTable
  type={{
    "lane.queue.depth.<lane_id>": {
      description: "各 lane 的待处理命令数",
    },
    "lane.queue.active.<lane_id>": {
      description: "各 lane 的活跃命令数",
    },
  }}
/>

**直方图**（分布）：

<TypeTable
  type={{
    "lane.command.latency_ms.<lane_id>": {
      description: "执行时间分布",
    },
    "lane.command.wait_time_ms.<lane_id>": {
      description: "队列等待时间分布",
    },
  }}
/>

### 直方图百分位数

```rust
pub struct HistogramStats {
    pub count: u64,
    pub sum: f64,
    pub min: f64,
    pub max: f64,
    pub mean: f64,
    pub percentiles: HistogramPercentiles,
}

pub struct HistogramPercentiles {
    pub p50: f64,
    pub p90: f64,
    pub p95: f64,
    pub p99: f64,
}
```

### 自定义指标后端

实现 `MetricsBackend` trait，将指标推送到你的监控系统：

```rust
use a3s_lane::MetricsBackend;

#[async_trait]
impl MetricsBackend for PrometheusBackend {
    async fn increment_counter(&self, name: &str, value: u64) {
        // 推送到 Prometheus
    }
    async fn set_gauge(&self, name: &str, value: f64) { /* ... */ }
    async fn record_histogram(&self, name: &str, value: f64) { /* ... */ }
    async fn get_counter(&self, name: &str) -> Option<u64> { /* ... */ }
    async fn get_gauge(&self, name: &str) -> Option<f64> { /* ... */ }
    async fn get_histogram_stats(&self, name: &str) -> Option<HistogramStats> { /* ... */ }
    async fn reset(&self) { /* ... */ }
    async fn snapshot(&self) -> MetricsSnapshot { /* ... */ }
}

let metrics = QueueMetrics::new(Arc::new(PrometheusBackend::new()));
```

## 告警

### 启用告警

```rust
use a3s_lane::AlertManager;

// 队列深度告警
let alerts = Arc::new(AlertManager::with_queue_depth_alerts(100, 500));

// 延迟告警（单位：毫秒）
let alerts = Arc::new(AlertManager::with_latency_alerts(500.0, 2000.0));

let manager = QueueManagerBuilder::new(emitter)
    .with_default_lanes()
    .with_alerts(alerts)
    .build()
    .await?;
```

### 告警级别

<TypeTable
  type={{
    "Warning": {
      description: "队列深度触发：>= warning 阈值 · 延迟触发：>= warning 阈值",
    },
    "Critical": {
      description: "队列深度触发：>= critical 阈值 · 延迟触发：>= critical 阈值",
    },
  }}
/>

### 告警回调

注册回调处理告警（发送到 Slack、PagerDuty 等）：

```rust
let alerts = Arc::new(AlertManager::with_queue_depth_alerts(100, 500));

alerts.add_callback(|alert| {
    println!("[{:?}] Lane '{}': {}",
        alert.level, alert.lane_id, alert.message);
}).await;
```

### 告警字段

```rust
pub struct Alert {
    pub lane_id: String,
    pub level: AlertLevel,      // Warning | Critical
    pub message: String,
    pub timestamp: DateTime<Utc>,
}
```

### 运行时配置阈值

```rust
use a3s_lane::{QueueDepthAlertConfig, LatencyAlertConfig};

let alerts = manager.alerts().unwrap();

alerts.set_queue_depth_config(QueueDepthAlertConfig {
    warning_threshold: 200,
    critical_threshold: 1000,
}).await;

alerts.set_latency_config(LatencyAlertConfig {
    warning_threshold: 1000.0,
    critical_threshold: 5000.0,
}).await;
```

## 监控

持续健康监控使用 `QueueMonitor`：

```rust
use a3s_lane::{QueueMonitor, MonitorConfig};
use std::time::Duration;

let monitor = QueueMonitor::with_config(
    manager.queue(),
    MonitorConfig {
        interval: Duration::from_secs(5),
        pending_warning_threshold: 50,
        active_warning_threshold: 20,
    },
);

// 启动后台监控
monitor.start().await;

// 按需查看统计
let stats = monitor.stats().await;
```
