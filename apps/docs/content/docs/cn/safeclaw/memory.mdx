---
title: 记忆系统
description: 三层记忆架构，包含资源、制品、洞察与隐私门控
---

# 记忆系统

SafeClaw 实现了三层记忆系统，将原始内容逐步提炼为结构化知识，并通过隐私门控在每一层控制访问权限。

## 三层架构

```
第一层：资源（原始内容）
    ↓ 提取器
第二层：制品（结构化知识）
    ↓ 合成器
第三层：洞察（跨会话综合）
```

### 第一层：资源

来自对话的原始内容：

```rust
pub enum ContentType {
    Text,
    Code,
    Data,
}

pub enum StorageLocation {
    Local,
    Tee,
}

pub struct Resource {
    pub id: String,
    pub content_type: ContentType,
    pub content: String,
    pub storage_location: StorageLocation,
    pub created_at: i64,
}
```

包含敏感数据的资源存储在 TEE 内存中（`StorageLocation::Tee`）。

### 第二层：制品

从资源中提取的结构化知识：

```rust
pub enum ArtifactType {
    Summary,
    CodeSnippet,
    DataPoint,
}

pub struct Artifact {
    pub id: String,
    pub artifact_type: ArtifactType,
    pub content: String,
    pub source_resources: Vec<String>,
    pub created_at: i64,
}
```

`Extractor`（提取器）将资源处理为制品——对对话进行摘要、提取代码片段、识别数据点。

### 第三层：洞察

跨会话综合分析：

```rust
pub enum InsightType {
    Pattern,
    Recommendation,
    Synthesis,
}

pub struct Insight {
    pub id: String,
    pub insight_type: InsightType,
    pub content: String,
    pub source_artifacts: Vec<String>,
    pub created_at: i64,
}
```

`Synthesizer`（合成器）跨会话组合制品，以识别模式、生成建议并构建更高层次的理解。

## 有界存储

所有记忆层均使用带安全擦除的有界 LRU 存储：

```rust
pub trait HasId {
    fn id(&self) -> &str;
}

pub trait Erasable {
    fn erase(&mut self);
}

pub struct BoundedStore<T: HasId + Erasable> {
    // LRU 淘汰，配合安全内存清零
}
```

当存储达到容量上限时，最近最少使用的条目会被淘汰。被淘汰的条目在释放前会被安全擦除（通过 `zeroize` 将内存清零）。

## 隐私门控

根据敏感程度控制对记忆的访问：

```rust
pub struct PrivacyGate {
    // 记忆访问控制
}
```

隐私门控强制执行以下规则：
- **读取访问**：只有具备相应敏感级别的会话才能读取敏感记忆
- **写入访问**：敏感数据自动路由至 TEE 存储
- **跨会话访问**：洞察在跨会话共享前会经过净化处理
- **擦除**：会话终止时，其敏感资源会被安全清除

## 存储层

```rust
pub struct ResourceStore { /* ... */ }
pub struct ArtifactStore { /* ... */ }
pub struct InsightStore { /* ... */ }
```

每个存储层独立管理，具备以下特性：
- 有界容量（LRU 淘汰）
- 淘汰和会话终止时的安全擦除
- 隐私感知的访问控制
- TEE 感知的存储位置选择
