---
title: Lane 队列
description: 基于优先级的任务队列与抢占
---

import { Tab, Tabs } from 'fumadocs-ui/components/tabs';
import { TypeTable } from 'fumadocs-ui/components/type-table';
import { Callout } from 'fumadocs-ui/components/callout';

# Lane 队列

Lane 队列提供基于优先级的任务调度，包含四个 lane。高优先级任务可抢占队列中已有的低优先级任务。

## Lane（优先级从高到低）

<TypeTable
  type={{
    "Control": {
      description: "优先级: 1（最高） · 使用场景: 停止/取消命令",
    },
    "Query": {
      description: "优先级: 2 · 使用场景: 只读查询",
    },
    "Execute": {
      description: "优先级: 3 · 使用场景: 文件写入、工具调用",
    },
    "Generate": {
      description: "优先级: 4（最低） · 使用场景: 长时间 LLM 生成",
    },
  }}
/>

## 基本队列设置

<Tabs groupId="lang" items={['Rust', 'Python', 'Node.js']}>
<Tab value="Rust">
```rust
use a3s_code_core::{Agent, SessionOptions, SessionQueueConfig};

let queue_config = SessionQueueConfig::default()
    .with_lane_features()
    .with_metrics();

let opts = SessionOptions::new()
    .with_permissive_policy()
    .with_queue_config(queue_config);

let session = agent.session("/my-project", Some(opts))?;

// 任务自动路由到适当的 lane
let result = session.send("List all Rust files", None).await?;
println!("{}", result.text);
```

**运行：** `cargo run --example test_task_priority`
**源码：** [`core/examples/test_task_priority.rs`](https://github.com/A3S-Lab/Code/blob/main/core/examples/test_task_priority.rs)
</Tab>
<Tab value="Python">
```python
from a3s_code import SessionQueueConfig

queue_config = SessionQueueConfig()
queue_config.enable_all_features = True

session = agent.session("/my-project",
    permissive=True,
    queue_config=queue_config,
)
result = await session.send("List all Rust files")
print(result.text)
```

**运行：** `python examples/test_task_priority.py`
**源码：** [`sdk/python/examples/test_task_priority.py`](https://github.com/A3S-Lab/Code/blob/main/sdk/python/examples/test_task_priority.py)
</Tab>
<Tab value="Node.js">
```javascript
const session = agent.session('/my-project', {
  permissive: true,
  queueConfig: { enableAllFeatures: true },
});
const result = await session.send('List all Rust files');
console.log(result.text);
```

**运行：** `node examples/test_task_priority.js`
**源码：** [`sdk/node/examples/test_task_priority.js`](https://github.com/A3S-Lab/Code/blob/main/sdk/node/examples/test_task_priority.js)
</Tab>
</Tabs>

## 优先级抢占

<Tabs groupId="lang" items={['Rust', 'Python', 'Node.js']}>
<Tab value="Rust">
```rust
use a3s_code_core::queue::{ExternalTask, SessionLane};

// 提交低优先级后台任务
session.submit_task(ExternalTask::new(
    "background-analysis",
    SessionLane::Generate,
    serde_json::json!({ "prompt": "Analyze the entire codebase" }),
)).await?;

// 提交高优先级查询，抢占后台任务
session.submit_task(ExternalTask::new(
    "urgent-query",
    SessionLane::Query,
    serde_json::json!({ "prompt": "What is the current git branch?" }),
)).await?;

// urgent-query 先执行，background-analysis 之后恢复
```
</Tab>
<Tab value="Python">
```python
# 提交低优先级后台任务
await session.submit_task({
    "id": "background-analysis",
    "lane": "generate",
    "payload": {"prompt": "Analyze the entire codebase"},
})

# 提交高优先级查询，抢占后台任务
await session.submit_task({
    "id": "urgent-query",
    "lane": "query",
    "payload": {"prompt": "What is the current git branch?"},
})
```
</Tab>
<Tab value="Node.js">
```javascript
// 提交低优先级后台任务
await session.submitTask({
  id: 'background-analysis',
  lane: 'generate',
  payload: { prompt: 'Analyze the entire codebase' },
});

// 提交高优先级查询，抢占后台任务
await session.submitTask({
  id: 'urgent-query',
  lane: 'query',
  payload: { prompt: 'What is the current git branch?' },
});
```
</Tab>
</Tabs>

<Callout type="info">
完整的 lane 队列文档，请参阅 [Lane 队列](/cn/docs/code/lane-queue)。
</Callout>

## API 参考

### SessionQueueConfig

<TypeTable
  type={{
    "启用 lane 功能": {
      description: {`Rust: \`.with_lane_features()\` · Python: \`enable_all_features=True\` · Node.js: \`enableAllFeatures: true\` · 默认值: \`false\``},
    },
    "启用指标": {
      description: {`Rust: \`.with_metrics()\` · Python: \`enable_metrics=True\` · Node.js: \`enableMetrics: true\` · 默认值: \`false\``},
    },
    "Query 并发数": {
      description: {`Rust: \`.query_max_concurrency(n)\` · Python: \`query_max_concurrency=n\` · Node.js: \`queryMaxConcurrency: n\` · 默认值: \`10\``},
    },
    "Execute 并发数": {
      description: {`Rust: \`.execute_max_concurrency(n)\` · Python: \`execute_max_concurrency=n\` · Node.js: \`executeMaxConcurrency: n\` · 默认值: \`5\``},
    },
  }}
/>

### ExternalTask 字段（Rust）

<TypeTable
  type={{
    "id": {
      description: {`类型: \`String\` · 描述: 唯一任务标识符`},
    },
    "lane": {
      description: {`类型: \`SessionLane\` · 描述: \`Control\`、\`Query\`、\`Execute\` 或 \`Generate\``},
    },
    "payload": {
      description: {`类型: \`serde_json::Value\` · 描述: 任务数据（提示、参数等）`},
    },
  }}
/>

### 队列管理方法

<TypeTable
  type={{
    "提交任务": {
      description: {`Rust: \`session.submit_task(task).await?\` · Python: \`await session.submit_task({...})\` · Node.js: \`await session.submitTask({...})\``},
    },
    "队列统计": {
      description: {`Rust: \`session.queue_stats().await\` · Python: \`await session.queue_stats()\` · Node.js: \`await session.queueStats()\``},
    },
    "队列指标": {
      description: {`Rust: \`session.queue_metrics().await\` · Python: \`await session.queue_metrics()\` · Node.js: \`await session.queueMetrics()\``},
    },
    "死信": {
      description: {`Rust: \`session.dead_letters().await\` · Python: \`await session.dead_letters()\` · Node.js: \`await session.deadLetters()\``},
    },
  }}
/>
