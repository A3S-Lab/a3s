---
title: å®‰å…¨
description: æƒé™ç³»ç»Ÿã€HITL ç¡®è®¤å’Œå¯æ‰©å±•å®‰å…¨ trait
---

import { Tab, Tabs } from 'fumadocs-ui/components/tabs';
import { TypeTable } from 'fumadocs-ui/components/type-table';
import { Callout } from 'fumadocs-ui/components/callout';
import { Steps, Step } from 'fumadocs-ui/components/steps';
import { Accordion, Accordions } from 'fumadocs-ui/components/accordion';

# å®‰å…¨

A3S Code æä¾›ä¸¤ä¸ªå†…ç½®å®‰å…¨å±‚ï¼š**æƒé™ç­–ç•¥** å’Œ **äººæœºååŒï¼ˆHITLï¼‰ç¡®è®¤**ã€‚å¯é€šè¿‡ `SecurityProvider` trait å’Œ `HookEngine` å®ç°é¢å¤–çš„å®‰å…¨é€»è¾‘ã€‚

## å®‰å…¨æ¶æ„

```
ç”¨æˆ·æç¤º â†’ Agent å¾ªç¯
  â”œâ”€ æƒé™ç­–ç•¥          â† Deny â†’ Allow â†’ Ask â†’ Default
  â”œâ”€ HITL ç¡®è®¤         â† ç‹¬ç«‹äºæƒé™ç³»ç»Ÿ
  â”œâ”€ å·¥å…·æ‰§è¡Œ
  â””â”€ SecurityProvider  â† é€šè¿‡ trait å¯æ’æ‹”ï¼ˆæ±¡ç‚¹è¿½è¸ªã€æ¸…æ´—ç­‰ï¼‰
```

## æƒé™ç­–ç•¥

æƒé™ç³»ç»Ÿæ§åˆ¶ agent å¯ä»¥ä½¿ç”¨å“ªäº›å·¥å…·ã€‚è§„åˆ™æŒ‰ä»¥ä¸‹é¡ºåºè¯„ä¼°ï¼š**Deny â†’ Allow â†’ Ask â†’ Default**ã€‚

### è§„åˆ™ç±»å‹

<TypeTable
  type={{
    "deny": {
      description: "ç«‹å³é˜»æ­¢å·¥å…·è°ƒç”¨",
    },
    "allow": {
      description: "å…è®¸å·¥å…·è°ƒç”¨",
    },
    "ask": {
      description: "æç¤ºç”¨æˆ·ç¡®è®¤ï¼ˆé€šè¿‡ HITLï¼‰",
    },
  }}
/>

### æ¨¡å¼åŒ¹é…

è§„åˆ™ä½¿ç”¨ glob é£æ ¼çš„æ¨¡å¼åŒ¹é…å·¥å…·åç§°å’Œå‚æ•°ï¼š

```
Tool(pattern)
```

<TypeTable
  type={{
    "bash(rm -rf:*)": {
      description: "ä»»ä½•ä»¥ rm -rf å¼€å¤´çš„ bash å‘½ä»¤",
    },
    "read(src/**)": {
      description: "src/ ä¸‹ä»»ä½•æ–‡ä»¶çš„è¯»å–æ“ä½œ",
    },
    "write(*)": {
      description: "æ‰€æœ‰å†™å…¥æ“ä½œ",
    },
    "mcp__pencil": {
      description: "æ‰€æœ‰ mcp__pencil__* å·¥å…·ï¼ˆå‰ç¼€åŒ¹é…ï¼‰",
    },
  }}
/>

é€šé…ç¬¦ï¼š`*` åŒ¹é…é™¤ `/` å¤–çš„ä»»ä½•å­—ç¬¦ï¼Œ`**` åŒ¹é…åŒ…æ‹¬ `/` çš„ä»»ä½•å­—ç¬¦ï¼Œ`:*` åŒ¹é…ä»»ä½•åç¼€ã€‚

### é¢„è®¾ç­–ç•¥

<TypeTable
  type={{
    "PermissionPolicy::permissive()": {
      description: "é»˜è®¤å…è®¸æ‰€æœ‰å·¥å…·ï¼ˆé»˜è®¤ï¼‰",
    },
    "PermissionPolicy::strict()": {
      description: "é»˜è®¤æ‹’ç»æ‰€æœ‰å·¥å…·",
    },
  }}
/>

### æ„å»ºè‡ªå®šä¹‰ç­–ç•¥

<Tabs groupId="lang" items={['Rust', 'TypeScript', 'Python']}>
<Tab value="Rust">
```rust
use a3s_code_core::permissions::PermissionPolicy;

let policy = PermissionPolicy::new()
    .deny("bash(rm -rf:*)")
    .deny("bash(curl:*|sh)")
    .allow("read(*)")
    .allow("glob(*)")
    .allow("grep(*)")
    .ask("write(*)")
    .ask("bash(*)");

// Apply to session
session.set_permission_policy(policy).await;
```
</Tab>
<Tab value="TypeScript">
```typescript
const { PermissionPolicy } = require('@a3s-lab/code');

const policy = new PermissionPolicy()
  .deny('bash(rm -rf:*)')
  .deny('bash(curl:*|sh)')
  .allow('read(*)')
  .allow('glob(*)')
  .allow('grep(*)')
  .ask('write(*)')
  .ask('bash(*)');

await session.setPermissionPolicy(policy);
```
</Tab>
<Tab value="Python">
```python
from a3s_code import PermissionPolicy

policy = PermissionPolicy()
policy.deny("bash(rm -rf:*)")
policy.deny("bash(curl:*|sh)")
policy.allow("read(*)")
policy.allow("glob(*)")
policy.allow("grep(*)")
policy.ask("write(*)")
policy.ask("bash(*)")

session.set_permission_policy(policy)
```
</Tab>
</Tabs>

### è¯„ä¼°é¡ºåº

è§„åˆ™æŒ‰ä»¥ä¸‹é¡ºåºè¯„ä¼°ï¼š

<Steps>
<Step>**Deny è§„åˆ™** â€” å¦‚æœä»»ä½• deny è§„åˆ™åŒ¹é…ï¼Œç«‹å³é˜»æ­¢</Step>
<Step>**Allow è§„åˆ™** â€” å¦‚æœä»»ä½• allow è§„åˆ™åŒ¹é…ï¼Œå…è®¸æ‰§è¡Œ</Step>
<Step>**Ask è§„åˆ™** â€” å¦‚æœä»»ä½• ask è§„åˆ™åŒ¹é…ï¼Œè§¦å‘ HITL ç¡®è®¤</Step>
<Step>**é»˜è®¤ç­–ç•¥** â€” å¦‚æœæ²¡æœ‰è§„åˆ™åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼ˆpermissive æˆ– strictï¼‰</Step>
</Steps>

ç¤ºä¾‹ï¼š

```rust
let policy = PermissionPolicy::new()
    .deny("bash(rm -rf:*)")      // Block destructive commands
    .allow("bash(git *)")         // Allow git commands
    .ask("bash(*)")               // Ask for all other bash commands
    .allow("read(*)")             // Allow all reads
    .ask("write(*)");             // Ask for all writes
```

## äººæœºååŒï¼ˆHITLï¼‰

HITL ç¡®è®¤**ç‹¬ç«‹äº**æƒé™ç³»ç»Ÿã€‚å³ä½¿å·¥å…·è¢«æƒé™ `allow`ï¼ŒHITL ä»ç„¶å¯ä»¥è¦æ±‚ç”¨æˆ·ç¡®è®¤ã€‚

### é…ç½®

<Tabs groupId="lang" items={['Rust', 'TypeScript', 'Python']}>
<Tab value="Rust">
```rust
use a3s_code_core::hitl::{ConfirmationPolicy, TimeoutAction};

let hitl = ConfirmationPolicy {
    enabled: true,
    default_timeout_ms: 30_000,
    timeout_action: TimeoutAction::Reject,
    ..Default::default()
};

let session = agent.session("/project", Some(
    SessionOptions::new().with_confirmation_policy(hitl)
))?;
```
</Tab>
<Tab value="TypeScript">
```typescript
const session = agent.session('/project', {
  confirmationPolicy: {
    enabled: true,
    timeoutMs: 30000,
    timeoutAction: 'reject',
  },
});
```
</Tab>
<Tab value="Python">
```python
from a3s_code import ConfirmationPolicy

session = agent.session("/project",
    confirmation_policy=ConfirmationPolicy(
        enabled=True,
        timeout_ms=30000,
        timeout_action="reject",
    ))
```
</Tab>
</Tabs>

### å¤„ç†ç¡®è®¤äº‹ä»¶

<Tabs groupId="lang" items={['Rust', 'TypeScript', 'Python']}>
<Tab value="Rust">
```rust
let (mut rx, _handle) = session.stream("Clean up old logs").await?;
while let Some(event) = rx.recv().await {
    match event {
        AgentEvent::ConfirmationRequired { tool_id, tool_name, args, .. } => {
            println!("ğŸ”’ Approve '{tool_name}'? {args:?}");
            // Approve or reject
            session.respond_confirmation(&tool_id, true, None).await;
        }
        AgentEvent::PermissionDenied { tool_name, reason, .. } => {
            println!("ğŸš« {tool_name} blocked: {reason}");
        }
        AgentEvent::TextDelta { text } => print!("{text}"),
        AgentEvent::End { .. } => break,
        _ => {}
    }
}
```
</Tab>
<Tab value="TypeScript">
```typescript
for await (const event of session.stream('Clean up old logs')) {
  if (event.type === 'confirmation_required') {
    console.log(`ğŸ”’ Approve '${event.toolName}'?`, event.toolArgs);
    await session.respondConfirmation(event.toolId, { approved: true });
  } else if (event.type === 'permission_denied') {
    console.log(`ğŸš« ${event.toolName} blocked: ${event.reason}`);
  } else if (event.type === 'text_delta') {
    process.stdout.write(event.text);
  }
}
```
</Tab>
<Tab value="Python">
```python
for event in session.stream("Clean up old logs"):
    if event.event_type == "confirmation_required":
        print(f"ğŸ”’ Approve '{event.tool_name}'? {event.tool_args}")
        session.respond_confirmation(event.tool_id, approved=True)
    elif event.event_type == "permission_denied":
        print(f"ğŸš« {event.tool_name} blocked: {event.reason}")
    elif event.event_type == "text_delta":
        print(event.text, end="", flush=True)
```
</Tab>
</Tabs>

### è¶…æ—¶è¡Œä¸º

<TypeTable
  type={{
    "Reject": {
      description: "è¶…æ—¶æœªå“åº”åˆ™æ‹’ç»å·¥å…·è°ƒç”¨ï¼ˆé»˜è®¤ï¼‰",
    },
    "Approve": {
      description: "è¶…æ—¶æœªå“åº”åˆ™æ‰¹å‡†å·¥å…·è°ƒç”¨",
    },
  }}
/>

## å·¥ä½œåŒºè¾¹ç•Œ

æ‰€æœ‰æ–‡ä»¶æ“ä½œé™åˆ¶åœ¨ä¼šè¯çš„å·¥ä½œåŒºç›®å½•å†…ã€‚å°è¯•è®¿é—®å·¥ä½œåŒºå¤–çš„æ–‡ä»¶ä¼šè¢«é˜»æ­¢ã€‚

```rust
let session = agent.session("/my-project", None)?;

// âœ… Allowed: within workspace
session.read_file("src/main.rs").await?;

// âŒ Blocked: outside workspace
session.read_file("../other-project/secret.txt").await?;
```

## é€šè¿‡ Trait æ‰©å±•å®‰å…¨

A3S Code æä¾› `SecurityProvider` trait ç”¨äºå®ç°è‡ªå®šä¹‰å®‰å…¨é€»è¾‘ï¼š

```rust
pub trait SecurityProvider: Send + Sync {
    /// Classify and register sensitive data found in input text
    fn taint_input(&self, text: &str) {}

    /// Sanitize output text by redacting sensitive data
    fn sanitize_output(&self, text: &str) -> String {
        text.to_string()
    }

    /// Securely wipe all session security state
    fn wipe(&self) {}

    /// Register security hooks with the given engine
    fn register_hooks(&self, hook_engine: &HookEngine) {}

    /// Unregister all hooks from the engine
    fn teardown(&self, hook_engine: &HookEngine) {}
}
```

### ç¤ºä¾‹ï¼šè‡ªå®šä¹‰å®‰å…¨æä¾›è€…

```rust
use a3s_code_core::security::SecurityProvider;
use a3s_code_core::hooks::{HookEngine, HookEvent, HookResult};

struct MySecurityProvider {
    // Your security state
}

impl SecurityProvider for MySecurityProvider {
    fn taint_input(&self, text: &str) {
        // Detect and track sensitive data (SSN, API keys, etc.)
    }

    fn sanitize_output(&self, text: &str) -> String {
        // Redact sensitive data from LLM output
        text.replace("sk-ant-", "[REDACTED]")
    }

    fn register_hooks(&self, hook_engine: &HookEngine) {
        // Register pre/post tool use hooks for security checks
        hook_engine.register(/* your hooks */);
    }
}

// Use in session
let security = Arc::new(MySecurityProvider { /* ... */ });
let session = agent.session("/project", Some(
    SessionOptions::new().with_security_provider(security)
))?;
```

å‚è§ [Hooks](/cn/docs/code/hooks) äº†è§£ç”Ÿå‘½å‘¨æœŸäº‹ä»¶é›†æˆã€‚

## æœ€ä½³å®è·µ

<Steps>
<Step>**ä»ä¸¥æ ¼ç­–ç•¥å¼€å§‹** â€” ä½¿ç”¨ `PermissionPolicy::strict()` å¹¶ä»…æ˜¾å¼å…è®¸éœ€è¦çš„å·¥å…·</Step>
<Step>**é˜»æ­¢å±é™©æ¨¡å¼** â€” å§‹ç»ˆæ‹’ç»ç ´åæ€§ bash å‘½ä»¤ï¼š`bash(rm -rf:*)`ã€`bash(curl:*|sh)`</Step>
<Step>**ä¸ºå†™æ“ä½œå¯ç”¨ HITL** â€” è¦æ±‚ç¡®è®¤æ–‡ä»¶ä¿®æ”¹å’Œ bash æ‰§è¡Œ</Step>
<Step>**ä½¿ç”¨å·¥ä½œåŒºè¾¹ç•Œ** â€” æ°¸è¿œä¸è¦ç¦ç”¨å·¥ä½œåŒºé™åˆ¶</Step>
<Step>**å®ç° SecurityProvider** â€” ä¸ºæ•æ„Ÿæ•°æ®æ·»åŠ è‡ªå®šä¹‰æ±¡ç‚¹è¿½è¸ªå’Œè¾“å‡ºæ¸…æ´—</Step>
<Step>**å®¡è®¡æ—¥å¿—** â€” ä½¿ç”¨ hooks è®°å½•æ‰€æœ‰å·¥å…·æ‰§è¡Œä»¥ä¾›å®‰å…¨å®¡æŸ¥</Step>
</Steps>

## å®‰å…¨äº‹ä»¶

Agent åœ¨æµå¼ä¼ è¾“æœŸé—´å‘å‡ºå®‰å…¨ç›¸å…³äº‹ä»¶ï¼š

<TypeTable
  type={{
    "PermissionDenied": {
      description: "å·¥å…·è°ƒç”¨è¢«æƒé™ç­–ç•¥é˜»æ­¢",
    },
    "ConfirmationRequired": {
      description: "éœ€è¦ HITL ç¡®è®¤",
    },
    "ConfirmationTimeout": {
      description: "ç”¨æˆ·æœªåœ¨è¶…æ—¶æ—¶é—´å†…å“åº”",
    },
    "ConfirmationRejected": {
      description: "ç”¨æˆ·æ‹’ç»äº†å·¥å…·è°ƒç”¨",
    },
  }}
/>

å‚è§ [ä¼šè¯](/cn/docs/code/sessions) è·å–å®Œæ•´äº‹ä»¶å‚è€ƒã€‚

## API å‚è€ƒ

### PermissionPolicy

<TypeTable
  type={{
    "PermissionPolicy::new()": {
      description: "åˆ›å»ºå®½æ¾é»˜è®¤ç­–ç•¥",
    },
    "PermissionPolicy::strict()": {
      description: "åˆ›å»ºå…¨éƒ¨æ‹’ç»é»˜è®¤ç­–ç•¥",
    },
    "PermissionPolicy::permissive()": {
      description: "åˆ›å»ºå…¨éƒ¨å…è®¸é»˜è®¤ç­–ç•¥",
    },
    ".allow(pattern)": {
      description: "æ·»åŠ å…è®¸è§„åˆ™",
    },
    ".deny(pattern)": {
      description: "æ·»åŠ æ‹’ç»è§„åˆ™",
    },
    ".ask(pattern)": {
      description: "æ·»åŠ è¯¢é—®ï¼ˆHITLï¼‰è§„åˆ™",
    },
    "session.set_permission_policy(p).await": {
      description: "åº”ç”¨åˆ°è¿è¡Œä¸­çš„ä¼šè¯",
    },
  }}
/>

### æ¨¡å¼è¯­æ³•

<TypeTable
  type={{
    "bash(*)": {
      description: "æ‰€æœ‰ bash è°ƒç”¨",
    },
    "bash(rm -rf:*)": {
      description: "ä»¥ rm -rf å¼€å¤´çš„ bash è°ƒç”¨",
    },
    "read(src/**)": {
      description: "è¯»å– src/ ä¸‹çš„ä»»ä½•æ–‡ä»¶",
    },
    "write(*)": {
      description: "æ‰€æœ‰å†™å…¥è°ƒç”¨",
    },
    "mcp__github": {
      description: "æ‰€æœ‰ mcp__github__* å·¥å…·",
    },
  }}
/>

### ConfirmationPolicy

<TypeTable
  type={{
    "enabled": {
      description: "ç±»å‹: bool Â· é»˜è®¤å€¼: false Â· æè¿°: å¯ç”¨ HITL",
    },
    "default_timeout_ms": {
      description: "ç±»å‹: u64 Â· é»˜è®¤å€¼: 30000 Â· æè¿°: ç¡®è®¤è¶…æ—¶æ—¶é—´",
    },
    "timeout_action": {
      description: "ç±»å‹: TimeoutAction Â· é»˜è®¤å€¼: Reject Â· æè¿°: è¶…æ—¶æ—¶ Reject æˆ– Allow",
    },
  }}
/>

### SecurityProvider traitï¼ˆRustï¼‰

<TypeTable
  type={{
    "taint_input": {
      description: "ç­¾å: fn taint_input(&self, text: &str) Â· æè¿°: æ£€æŸ¥ç”¨æˆ·è¾“å…¥ä¸­çš„æ•æ„Ÿæ¨¡å¼",
    },
    "sanitize_output": {
      description: "ç­¾å: fn sanitize_output(&self, text: &str) -> String Â· æè¿°: ä» LLM è¾“å‡ºä¸­è„±æ•æ•æ„Ÿæ¨¡å¼",
    },
    "wipe": {
      description: "ç­¾å: fn wipe(&self) Â· æè¿°: æ¸…é™¤ç¼“å­˜çš„æ•æ„ŸçŠ¶æ€",
    },
    "register_hooks": {
      description: "ç­¾å: fn register_hooks(&self, engine: &HookEngine) Â· æè¿°: é™„åŠ  hooks è¿›è¡Œæ·±åº¦æ‹¦æˆª",
    },
    "teardown": {
      description: "ç­¾å: fn teardown(&self) Â· æè¿°: ä¼šè¯ç»“æŸæ—¶è°ƒç”¨",
    },
  }}
/>
