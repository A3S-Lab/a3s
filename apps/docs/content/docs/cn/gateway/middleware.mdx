---
title: 中间件
description: 15 种内置中间件，涵盖认证、限流、CORS 等功能
---

import { TypeTable } from 'fumadocs-ui/components/type-table';

# 中间件

A3S Gateway 提供 15 种内置中间件，可组合成有序的处理管道。在 `handle_request` 中返回响应会立即短路整个管道。

## 内置中间件

### JWT 认证

使用 HS256 验证 `Authorization: Bearer` 令牌。验证失败返回 `401`。

```hcl
middlewares "auth-jwt" {
  type  = "jwt"
  value = "${JWT_SECRET}"
}
```

### API Key 认证

将请求头的值与白名单进行比对。验证失败返回 `401`。

```hcl
middlewares "auth-apikey" {
  type   = "api-key"
  header = "X-API-Key"
  keys   = ["key-1", "key-2", "key-3"]
}
```

### Basic 认证

HTTP Basic Auth。验证失败返回 `401` 并附带 `WWW-Authenticate` 响应头。

```hcl
middlewares "auth-basic" {
  type     = "basic-auth"
  username = "admin"
  password = "secret"
}
```

### 外部认证转发

将认证委托给外部服务。将认证响应中指定的请求头复制到上游请求。认证服务拒绝时返回 `401`。

```hcl
middlewares "ext-auth" {
  type                          = "forward-auth"
  forward_auth_url              = "http://auth.internal:9090/verify"
  forward_auth_response_headers = ["X-User-Id", "X-User-Role"]
}
```

### 限流（内存）

令牌桶限流器。令牌耗尽时返回 `429 Too Many Requests`。

```hcl
middlewares "rate-limit" {
  type  = "rate-limit"
  rate  = 100
  burst = 50
}
```

### 限流（Redis）

通过 Redis 实现分布式限流。需要启用 `--features redis`。

```hcl
middlewares "rate-limit-distributed" {
  type      = "rate-limit-redis"
  rate      = 200
  burst     = 100
  redis_url = "redis://127.0.0.1:6379"
}
```

### CORS

设置 CORS 响应头，自动处理预检 `OPTIONS` 请求。

```hcl
middlewares "cors" {
  type            = "cors"
  allowed_origins = ["https://example.com", "https://app.example.com"]
  allowed_methods = ["GET", "POST", "PUT", "DELETE"]
  allowed_headers = ["Content-Type", "Authorization"]
  max_age         = 3600
}
```

### 请求头操作

添加或覆盖请求/响应头。

```hcl
middlewares "custom-headers" {
  type = "headers"
  request_headers = {
    "X-Forwarded-Proto" = "https"
  }
  response_headers = {
    "X-Frame-Options" = "DENY"
    "Strict-Transport-Security" = "max-age=31536000"
  }
}
```

### 路径前缀剥离

在转发到后端之前移除路径前缀。

```hcl
middlewares "strip-api" {
  type     = "strip-prefix"
  prefixes = ["/api/v1", "/api/v2"]
}
```

### 请求体大小限制

拒绝超过请求体大小限制的请求，返回 `413 Payload Too Large`。

```hcl
middlewares "body-limit" {
  type           = "body-limit"
  max_body_bytes = 1048576
}
```

### 重试

以可配置的间隔重试失败的请求。

```hcl
middlewares "retry" {
  type              = "retry"
  max_retries       = 3
  retry_interval_ms = 500
}
```

### 熔断器

Closed → Open → HalfOpen 状态机。连续失败后开启熔断，冷却后尝试半开状态。

```hcl
middlewares "circuit-breaker" {
  type              = "circuit-breaker"
  failure_threshold = 5
  cooldown_secs     = 30
  success_threshold = 2
}
```

### IP 白名单

拒绝不在白名单中的 IP 请求，支持 CIDR 表示法，返回 `403`。

```hcl
middlewares "ip-allow" {
  type        = "ip-allow"
  allowed_ips = ["192.168.1.0/24", "10.0.0.0/8"]
}
```

### 压缩

根据 `Accept-Encoding` 使用 brotli（优先）、gzip 或 deflate 压缩响应。

```hcl
middlewares "compress" {
  type = "compress"
}
```

### TCP 过滤器

TCP 入口点的连接级过滤：并发连接数限制和 IP 白名单。通过入口点字段配置：

```hcl
entrypoints "tcp-db" {
  address         = "0.0.0.0:5432"
  protocol        = "tcp"
  max_connections  = 1000
  tcp_allowed_ips  = ["10.0.0.0/8", "192.168.1.0/24"]
}
```

## 汇总

<TypeTable
  type={{
    "jwt": {
      type: "401",
      description: "JWT Bearer token validation",
    },
    "api-key": {
      type: "401",
      description: "Header-based API key check",
    },
    "basic-auth": {
      type: "401",
      description: "HTTP Basic authentication",
    },
    "forward-auth": {
      type: "401",
      description: "External auth delegation",
    },
    "rate-limit": {
      type: "429",
      description: "In-memory token bucket",
    },
    "rate-limit-redis": {
      type: "429",
      description: "Distributed token bucket (Redis)",
    },
    "cors": {
      description: "CORS headers + preflight",
    },
    "headers": {
      description: "Request/response header manipulation",
    },
    "strip-prefix": {
      description: "Path prefix removal",
    },
    "body-limit": {
      type: "413",
      description: "Max request body size",
    },
    "retry": {
      description: "Retry on backend failure",
    },
    "circuit-breaker": {
      type: "503",
      description: "Closed/Open/HalfOpen state machine",
    },
    "ip-allow": {
      type: "403",
      description: "CIDR/IP allowlist",
    },
    "compress": {
      description: "brotli/gzip/deflate compression",
    },
    "tcp-filter": {
      description: "TCP connection limit + IP filter",
    },
  }}
/>
