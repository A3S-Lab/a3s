---
title: A3S Event
description: 提供商无关的事件总线，支持 Schema 验证、加密、死信队列和可观测性
---

import { TypeTable } from 'fumadocs-ui/components/type-table';

# A3S Event

A3S Event 是面向 Rust 的提供商无关事件系统。所有后端实现 `EventProvider` trait — 无需修改应用代码即可在 NATS JetStream 和内存模式之间切换。

## 特性标志

所有可选模块都在特性门控后面，最小核心编译时零可选依赖。

<TypeTable
  type={
    "nats": {
      description: "默认: ✅ · 说明: NATS JetStream 提供商",
    },
    "encryption": {
      description: "默认: ✅ · 说明: AES-256-GCM 载荷加密，支持密钥轮换",
    },
    "cloudevents": {
      description: "默认: ✅ · 说明: CloudEvents v1.0 转换",
    },
    "routing": {
      description: "默认: ✅ · 说明: Broker/Trigger 事件路由 + 事件 Sink",
    },
  }
/>

```toml
# 完整版（默认）
a3s-event = "0.3"

# 仅最小核心
a3s-event = { version = "0.3", default-features = false }

# 按需选择
a3s-event = { version = "0.3", default-features = false, features = ["nats"] }
```

## 架构

```
┌──────────────────────────────────────────────────────────┐
│                        EventBus                          │
│                                                          │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │ SchemaReg   │  │  Encryptor   │  │  DLQ Handler  │  │
│  │ validate()  │  │ AES-256-GCM  │  │ MemoryDlq     │  │
│  └──────┬──────┘  └──────┬───────┘  └──────┬────────┘  │
│         │                │                  │            │
│         └────── publish ─┴── subscribe ─────┘            │
│                       │                                  │
│  ┌────────────────────┴────────────────────────────┐    │
│  │              EventProvider（trait）               │    │
│  │  publish · subscribe · durable · history · ack   │    │
│  └──────────────┬──────────────────┬───────────────┘    │
│                 │                  │                      │
│  ┌──────────────┴───┐  ┌──────────┴──────────┐         │
│  │  MemoryProvider   │  │   NatsProvider      │         │
│  │  tokio::broadcast │  │   JetStream         │         │
│  │  零依赖           │  │   持久订阅          │         │
│  └──────────────────┘  └─────────────────────┘         │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ StateStore   │  │ EventMetrics │  │ Broker       │  │
│  │ 文件 / 内存  │  │ 无锁原子计数 │  │ 路由 ⚑      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────────────────────────────────────┘

⚑ = 特性门控
```

## 提供商对比

<TypeTable
  type={
    "发布/订阅": {
      description: "MemoryProvider: ✅ · NatsProvider: ✅",
    },
    "历史/重放": {
      description: "MemoryProvider: 内存缓冲 · NatsProvider: JetStream 流",
    },
    "持久订阅": {
      description: "MemoryProvider: 否 · NatsProvider: ✅",
    },
    "通配符": {
      description: {`MemoryProvider: ✅（\`>\`、\`*\`） · NatsProvider: ✅（NATS 主题）`},
    },
    "去重": {
      description: "MemoryProvider: 否 · NatsProvider: ✅（msg_id）",
    },
    "手动 Ack/Nak": {
      description: "MemoryProvider: 否 · NatsProvider: ✅",
    },
    "背压": {
      description: "MemoryProvider: 否 · NatsProvider: ✅（max_ack_pending）",
    },
    "健康检查": {
      description: "MemoryProvider: 始终健康 · NatsProvider: 连接检查",
    },
    "持久化": {
      description: "MemoryProvider: 无 · NatsProvider: 文件或内存存储",
    },
    "适用场景": {
      description: "MemoryProvider: 开发、测试 · NatsProvider: 生产",
    },
  }
/>

## 核心类型

<TypeTable
  type={
    "EventProvider": {
      description: "核心 trait — 所有后端实现此接口",
    },
    "EventBus": {
      description: "高级 API，带订阅管理",
    },
    "Event": {
      description: "消息信封（id、subject、category、event_type、version、payload）",
    },
    "ReceivedEvent": {
      description: "带投递上下文的事件（sequence、num_delivered、stream）",
    },
    "Subscription": {
      description: "来自任意提供商的异步事件流",
    },
    "PendingEvent": {
      description: "带 ack/nak 回调的事件，用于手动确认",
    },
    "SchemaRegistry": {
      description: "事件类型验证，支持兼容性检查",
    },
    "StateStore": {
      description: "持久化订阅状态的 trait",
    },
    "EventMetrics": {
      description: "无锁原子计数器",
    },
    "DlqHandler": {
      description: "死信队列 trait",
    },
  }
/>

## 测试覆盖

176 个单元测试 + 29 个内存集成测试 + 9 个 NATS 集成测试 + 2 个文档测试。
