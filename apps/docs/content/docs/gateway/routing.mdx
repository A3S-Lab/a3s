---
title: Routing
description: Rule-based request matching with Host, Path, Headers, Method, and SNI matchers
---

# Routing

A3S Gateway uses a Traefik-compatible rule syntax for matching incoming requests to services.

## Rule Syntax

```
rule = "Matcher(`value`) && Matcher(`value`)"
```

### Supported Matchers

| Matcher | Description | Example |
|---------|-------------|---------|
| `Host` | Match by hostname | `Host(\`api.example.com\`)` |
| `PathPrefix` | Match by path prefix | `PathPrefix(\`/api\`)` |
| `Path` | Match exact path | `Path(\`/health\`)` |
| `Headers` | Match by header key/value | `Headers(\`X-Api-Version\`, \`v2\`)` |
| `Method` | Match by HTTP method | `Method(\`POST\`)` |
| `HostSNI` | Match TCP by TLS SNI | `HostSNI(\`db.example.com\`)` |

### Combining Matchers

Use `&&` to combine multiple matchers (AND logic):

```hcl
routers "api-v1" {
  rule    = "Host(`api.example.com`) && PathPrefix(`/v1`)"
  service = "api-v1"
}

routers "webhooks" {
  rule    = "Method(`POST`) && PathPrefix(`/webhooks`)"
  service = "webhook-handler"
}

routers "internal" {
  rule    = "Headers(`X-Internal`, `true`) && PathPrefix(`/admin`)"
  service = "admin-service"
}
```

## Priority

When multiple routers match, the lowest `priority` value wins (default: `0`):

```hcl
routers "specific" {
  rule     = "Host(`api.example.com`) && Path(`/health`)"
  service  = "health-service"
  priority = 0
}

routers "general" {
  rule     = "Host(`api.example.com`)"
  service  = "api-service"
  priority = 10
}
```

## Entrypoint Binding

Routers only receive traffic from their bound entrypoints:

```hcl
entrypoints "web" {
  address = "0.0.0.0:80"
}

entrypoints "websecure" {
  address = "0.0.0.0:443"
  tls {
    cert_file = "cert.pem"
    key_file  = "key.pem"
  }
}

# HTTPS only
routers "api" {
  rule        = "Host(`api.example.com`)"
  service     = "api-service"
  entrypoints = ["websecure"]
}

# Both HTTP and HTTPS
routers "web" {
  rule        = "Host(`www.example.com`)"
  service     = "web-service"
  entrypoints = ["web", "websecure"]
}
```

## Middleware Chain

Middlewares are applied in the order listed. If any middleware rejects the request, the pipeline short-circuits immediately.

```hcl
routers "api" {
  rule        = "Host(`api.example.com`)"
  service     = "api-service"
  middlewares = ["ip-allow", "auth-jwt", "rate-limit", "cors"]
  # Order: IP check → JWT auth → rate limit → CORS headers
}
```

## TCP/UDP Routing

TCP entrypoints use SNI from the TLS ClientHello:

```hcl
entrypoints "tcp-secure" {
  address  = "0.0.0.0:5432"
  protocol = "tcp"
}

routers "postgres" {
  rule        = "HostSNI(`db.example.com`)"
  service     = "postgres-service"
  entrypoints = ["tcp-secure"]
}
```

UDP routing is port-based — each UDP entrypoint maps to a single service.

## Examples

### API Versioning

```hcl
routers "api-v2" {
  rule     = "Host(`api.example.com`) && PathPrefix(`/v2`)"
  service  = "api-v2"
  priority = 0
}

routers "api-v1" {
  rule     = "Host(`api.example.com`) && PathPrefix(`/v1`)"
  service  = "api-v1"
  priority = 1
}

routers "api-fallback" {
  rule     = "Host(`api.example.com`)"
  service  = "api-v2"
  priority = 100
}
```

### Multi-Tenant

```hcl
routers "tenant-a" {
  rule    = "Host(`a.example.com`)"
  service = "tenant-a-backend"
}

routers "tenant-b" {
  rule    = "Host(`b.example.com`)"
  service = "tenant-b-backend"
}
```

### Header-Based Canary

```hcl
routers "canary" {
  rule     = "Headers(`X-Canary`, `true`) && PathPrefix(`/api`)"
  service  = "canary-backend"
  priority = 0
}

routers "stable" {
  rule     = "PathPrefix(`/api`)"
  service  = "stable-backend"
  priority = 10
}
```
