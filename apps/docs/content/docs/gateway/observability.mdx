---
title: Observability
description: Prometheus metrics, structured logging, distributed tracing, and dashboard API
---

# Observability

A3S Gateway provides built-in metrics, structured access logging, distributed tracing, and a dashboard API for monitoring.

## Metrics

```rust
pub struct GatewayMetrics {
    total_requests: AtomicU64,
    status_2xx: AtomicU64,
    status_3xx: AtomicU64,
    status_4xx: AtomicU64,
    status_5xx: AtomicU64,
    total_response_bytes: AtomicU64,
    active_connections: AtomicI64,
    router_requests: Arc<RwLock<HashMap<String, u64>>>,
    backend_requests: Arc<RwLock<HashMap<String, u64>>>,
}
```

### Recording

```rust
impl GatewayMetrics {
    pub fn record_request(&self, status: u16, response_bytes: u64);
    pub fn record_router_request(&self, router: &str);
    pub fn record_backend_request(&self, backend: &str);
    pub fn inc_connections(&self);
    pub fn dec_connections(&self);
    pub fn snapshot(&self) -> MetricsSnapshot;
    pub fn render_prometheus(&self) -> String;
}
```

### Prometheus Export

```text
gateway_requests_total 12345
gateway_responses_total{status_class="2xx"} 11000
gateway_responses_total{status_class="3xx"} 500
gateway_responses_total{status_class="4xx"} 700
gateway_responses_total{status_class="5xx"} 145
gateway_response_bytes_total 987654321
gateway_active_connections 42
gateway_router_requests{router="api"} 8000
gateway_router_requests{router="web"} 4345
gateway_backend_requests{backend="http://127.0.0.1:8001"} 6000
gateway_backend_requests{backend="http://127.0.0.1:8002"} 6345
```

### Metrics Snapshot

```rust
pub struct MetricsSnapshot {
    pub total_requests: u64,
    pub status_classes: HashMap<String, u64>,
    pub total_response_bytes: u64,
    pub active_connections: i64,
    pub router_requests: HashMap<String, u64>,
    pub backend_requests: HashMap<String, u64>,
}
```

## Dashboard API

The gateway exposes a built-in REST API for monitoring:

| Endpoint | Description |
|----------|-------------|
| `GET /api/gateway/health` | Health status (JSON) |
| `GET /api/gateway/metrics` | Prometheus text format |
| `GET /api/gateway/config` | Current configuration (JSON) |

### Health Response

```json
{
  "state": "Running",
  "uptime_secs": 3600,
  "active_connections": 42,
  "total_requests": 12345
}
```

```rust
pub struct HealthStatus {
    pub state: GatewayState,
    pub uptime_secs: u64,
    pub active_connections: usize,
    pub total_requests: u64,
}
```

## Access Logging

Structured JSON access logs via the `tracing` crate:

```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "client_ip": "203.0.113.42",
  "method": "POST",
  "path": "/api/v1/chat",
  "status": 200,
  "request_duration_ms": 145,
  "bytes_sent": 2048,
  "router": "api",
  "service": "api-backend",
  "backend": "http://127.0.0.1:8001"
}
```

### Log Levels

```bash
# Set via CLI
a3s-gateway --config gateway.toml --log-level debug

# Set via environment
RUST_LOG=a3s_gateway=debug a3s-gateway --config gateway.toml
```

| Level | Description |
|-------|-------------|
| `error` | Failures, backend errors, TLS errors |
| `warn` | Rate limit hits, unhealthy backends, config issues |
| `info` | Startup, shutdown, reload, access logs |
| `debug` | Request routing decisions, middleware execution |
| `trace` | Raw bytes, header details, connection lifecycle |

## Distributed Tracing

A3S Gateway propagates trace context across services:

- **W3C Trace Context**: `traceparent` / `tracestate` headers
- **B3/Zipkin**: `X-B3-TraceId` / `X-B3-SpanId` headers

Spans are created for:
- Request lifecycle (entrypoint → router → middleware → proxy → response)
- Backend connections
- Health check probes

## Grafana Dashboard Queries

```text
# Request rate (per second)
rate(gateway_requests_total[5m])

# Error rate (4xx + 5xx)
rate(gateway_responses_total{status_class=~"4xx|5xx"}[5m])

# Success rate percentage
rate(gateway_responses_total{status_class="2xx"}[5m])
  / rate(gateway_requests_total[5m]) * 100

# Active connections
gateway_active_connections

# Traffic by router
rate(gateway_router_requests[5m])

# Backend distribution
rate(gateway_backend_requests[5m])

# Throughput (bytes/sec)
rate(gateway_response_bytes_total[5m])
```
